# CivitAI Prompt Collector (Rebuild)

CivitAI からプロンプトを収集し、10カテゴリに自動分類してWD14 Tagger補強システムを構築、ComfyUI と連携するための高度なプロンプト提案システムです。

---

## 📋 必須動作ルール（絶対遵守）

### Rule 1: このドキュメント最優先
- このドキュメント内の「プロジェクト運用ルール」を絶対に守る
- 「次回最優先タスク」が指定されている場合、それ以外の作業提案は禁止

### Rule 2: Project Objectives絶対準拠
全ての提案は以下の最終目標に照らして判断：
1. CivitAI条件指定プロンプト自動収集
2. 自動カテゴリ分け（10カテゴリ）
3. WD14 Tagger基本プロンプト補強システム
4. ComfyUI連携によるプロンプト提案 

### Rule 3: フェーズ完結型実装強制
- ❌ エラー報告に対する即座の修正コード提示は禁止
- ✅ 「Phase完了後にまとめて問題を報告してください」
- ✅ 包括的修正のみ提案

### Rule 4: チャットコメントのルール
- 現在対応中のフェーズやタスクを必ず記載すること。
  - 例: 「現在フェーズ 2-1: 重複処理の改善を実施中」

---

## 📋 プロジェクト概要

**目的**: CivitAI APIからプロンプトを収集し、10カテゴリに細分化してWD14 Tagger補強システムを構築
**最終目標**: 参照画像→WD14基本プロンプト→カテゴリ別補強→表現力豊かなプロンプト生成システム

---

## 🎯 実現できること

1. **プロンプト収集**: CivitAI APIから条件指定で大量プロンプト取得
2. **自動カテゴライズ**: 10カテゴリ（NSFW, style, lighting, composition, mood, basic, technical, pose, angle, camera_film）に自動分類
3. **WD14連携**: 基本プロンプト→カテゴリ別要素で補強→完成プロンプト生成
4. **重複排除**: IDベースで重複データを自動除去
5. **統計分析**: カテゴリ別統計、アナログ写真技術要素の分析
6. **API提供**: RESTful APIでComfyUI等から利用可能

---

## 🚀 開発工程

### フェーズ 1: 初期評価と問題特定
- 1-1: 重複処理の問題を特定
- 1-2: テストカバレッジの不足を確認
- 1-3: デバッグログの改善点を洗い出し

### フェーズ 2: 重複処理の改善
- 2-1: `save_to_db` メソッドのリファクタリング
- 2-2: 重複エントリを防ぐロジックを導入
- 2-3: データベーストランザクションの適切なコミットを実装

### フェーズ 3: テストカバレッジの拡大
- 3-1: 無効なデータやエラーハンドリングのテストを追加
- 3-2: インメモリSQLiteデータベースを使用したテスト環境の整備

### フェーズ 4: スケーラビリティテスト
- 4-1: 大量データを用いたテストを計画
- 4-2: データベース操作のパフォーマンスを検証

### フェーズ 5: ComfyUI統合
- 5-1: APIエンドポイントの最適化
- 5-2: ComfyUIとのデータ連携機能を実装
- 5-3: 統合テストを実施

### フェーズ 6: プロンプト収集UIの実装
- 6-1: UIデザインと要件定義
  - モデル名、モデルID、バージョンIDの入力欄を設置。
  - 収集開始ボタン、収集ステータス表示、結果表示を含む。
- 6-2: UIの実装
  - Streamlitを使用してシンプルなWebインターフェースを構築。
  - 既存のプロンプト収集ロジックを統合。
  - 10カテゴリ分類システムの実装。
  - WD14プロンプト補強機能の実装。
- 6-3: データ保存とステータス管理
  - 収集データを自動保存する仕組みを実装。
  - 収集中のステータスをリアルタイムで表示。
- 6-4: テストとデプロイ
  - UIの動作確認とバグ修正。
  - ユーザーが利用可能な形でデプロイ。

---

## 最短動作
```
python -m venv .venv
# Windows: .venv\Scripts\activate
pip install -r backend/requirements.txt

python backend/src/collector/collector.py  # フェーズ 1
python backend/src/classify/rule_classifier.py  # フェーズ 3
node api/src/index.js  # フェーズ 4
```

## 最近の変更点
- **テストカバレッジの拡張**: 無効なデータ、エラーハンドリング、大規模データセットに対するテストを追加。
- **パフォーマンス最適化**: `save_to_db` メソッドのプロファイリングを実施し、バッチ処理を導入して効率化。
- **スケーラビリティテスト**: 大規模データセットを使用してデータベースのパフォーマンスを評価。

---

## TODO
- CivitAI API 正式エンドポイント調整
- 前処理（正規化/重複排除）
- キーワード拡張
- Embedding + クラスタリング
- ComfyUI 連携仕様 doc 化
- ドキュメントのさらなる改善
